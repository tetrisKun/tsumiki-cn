---
description: 执行 TDD 的 Green 阶段。实现使失败的测试用例通过的代码,并确认测试成功。
allowed-tools: Read, Glob, Grep, Task, Write, Edit, TodoWrite
argument-hint: [需求名称] [TASK-ID]
---
执行 TDD 的 Green 阶段,实现使 Red 阶段创建的测试通过的代码。

# context

输出目录="./docs/implements"
功能名={{feature_name}}
任务ID={{task_id}}
需求名称={{requirement_name}}
可靠性评估=[]
备忘文件=./docs/implements/{需求名称}/{{task_id}}/{feature_name}-memo.md
需求定义文件=./docs/implements/{需求名称}/{{task_id}}/{feature_name}-requirements.md
测试用例文件=./docs/implements/{需求名称}/{{task_id}}/{feature_name}-testcases.md
Red阶段文件=./docs/implements/{需求名称}/{{task_id}}/{feature_name}-red-phase.md
Green阶段文件=./docs/implements/{需求名称}/{{task_id}}/{feature_name}-green-phase.md

# step

- 如果没有 $ARGUMENTS,显示"请在参数中指定需求名称和TASK-ID(例如:用户认证功能 TASK-0001)"并退出
- 向用户声明 $ARGUMENTS 的内容和 context 的内容
- 执行 step2

## step2: 上下文准备

执行开发上下文准备:

1. **确认现有实施文档**
   - 确认 `./docs/implements/{需求名称}/{{task_id}}/` 目录内的所有MD文件
   - 优先读取以下文件:
     - `note.md` - 任务笔记(技术栈、开发规则、相关实现)
     - `{feature_name}-requirements.md` - 需求定义
     - `{feature_name}-testcases.md` - 测试用例定义
     - `{feature_name}-red-phase.md` - Red阶段的测试记录
     - `{feature_name}-green-phase.md` - 现有Green阶段记录
     - `{feature_name}-memo.md` - 开发历史备忘
     - 其他相关MD文件
   - 从这些文件中了解现有实现状态、设计决策、注意事项

2. **读取附加规则**
   - 如果存在 `AGENTS.md` 文件则读取
   - 如果存在 `./docs/rule` 目录则读取
   - 如果存在 `./docs/rule/tdd` 目录则读取
   - 如果存在 `./docs/rule/tdd/green` 目录则读取
   - 读取各目录内的所有文件,作为附加规则应用

3. **使用 @agent-symbol-searcher 搜索实现相关信息,并读取找到的文件**
   - 搜索现有的类似功能或实用函数,使用Read工具读取相应文件
   - 识别实现模式或架构指南,使用Read工具读取设计文档
   - 确认依赖关系和导入路径,使用Read工具读取相关文件

4. **直接读取相关外部文件**
   - 根据需要读取相关设计文档或任务文件
   - 项目整体的设计文档、架构文档等

读取完成后,执行 step3

## step3: 执行实现

- **确认与规格的差异**:
  - 实现前仔细检查需求定义文件和测试用例文件的内容
  - 如果发现当前实现代码与规格之间存在差异:
    1. 具体识别差异内容
    2. 如果无法判断哪个正确,使用 AskUserQuestion 工具向用户确认
    3. 明确说明"规格: [规格描述]""实现: [实现内容]"进行提问
    4. 等待用户判断后再继续实现

- 按照 <implementation_template> 的方针进行实现
  - 利用读取的上下文信息
  - 在各实现中记载可靠性级别(🔵🟡🔴)
  - 包含必要的中文注释
  - 注意文件大小(800行限制)
  - 遵守模拟使用的限制

- 使用 @task 执行测试并确认结果
  - 确认所有测试都通过
  - 如果失败,调查原因并重复修正
  - 如果现有测试出现错误,基于规格进行适当修正

- 根据质量判定标准评估实现内容的以下方面:
  - 测试成功状况
  - 实现的简洁性
  - 重构部分的明确性
  - 功能性问题的有无
  - 文件大小(800行限制)
  - 模拟使用的适当性

- 向用户显示质量判定结果
- 执行 step4

## step4: 文档更新

- **创建・更新Green-phase文件**:
  - 将实现代码和设计内容保存到 {{Green阶段文件}}
  - 如果存在现有文件则追加
  - 记录以下内容:
    - 实现代码的全文
    - 实现方针和判断理由
    - 测试执行结果
    - 课题・改善点(在Refactor阶段处理)

- **更新备忘文件**:
  - 更新 {{备忘文件}} 的Green阶段部分
  - 如果不存在现有备忘文件,按照TDD备忘文件格式新建
  - 记录以下内容:
    - 实现日期时间
    - 实现方针
    - 实现代码
    - 测试结果
    - 课题・改善点

- 执行 step5

## step5: TODO更新和下一步判定

- 使用 TodoWrite 工具更新 TODO 状态
  - 将当前TODO"Green阶段(最小实现)"标记为"completed"
  - 在TODO内容中反映最小实现阶段的完成
  - 在TODO内容中记录质量判定结果
  - 添加下一阶段"Refactor阶段(质量改善)"到TODO

- **自动过渡判定**: 如果满足以下条件,自动执行 `/tsumiki:tdd-refactor {需求名称} {TASK-ID}`
  - 使用Task工具确认所有测试都已成功
  - 实现简洁易懂
  - 有明显的重构部分
  - 没有功能性问题

- **手动确认**: 如果不满足自动过渡条件,提供以下内容:
  - "使用Task工具确认测试已通过。"
  - "当前实现: [简洁说明]"
  - "实现中包含的中文注释: [注释的目的和内容]"
  - "重构候选: [应改善的点]"
  - "是否可以进入下一个Refactor阶段?"

# rules

## 实现原则

- **确认与规格的一致性是最优先的**
- 实现前必须对照规格(需求定义・测试用例)和当前实现
- 如果发现差异,不要独断前进,使用 AskUserQuestion 工具向用户寻求确认
- **确保测试通过是最优先的**
- 代码的美观性其次(在下一个Refactor阶段改善)
- "暂时能运行"的水平即可
- 复杂逻辑留待后续,力求简洁实现
- 测试难以通过时,使用Task工具调查失败原因后制定修正计划再实现
- 如果现有测试出现错误,基于规格进行适当修正

## 禁止事项(NEVER)

- 禁止跳过必要的测试
- 禁止删除必要的测试
- 禁止在实现代码中描述模拟・桩
- 禁止在实现代码中使用替代数据库的内存存储
- 禁止在实现代码中省略数据库操作

## 文件大小管理

- **800行限制**: 实现文件超过800行时考虑文件分割
- **模块设计**: 按功能单位适当分离文件
- **函数分割**: 将长函数分割成小单位实现
- **责任边界**: 明确各文件的责任范围并实现
- **分割策略**: 按功能・层・域分离文件

## 限制模拟使用

- **实现代码限制**: 在实现代码中不使用模拟・桩
- **测试代码限定**: 模拟仅在测试代码中使用
- **实际逻辑实现**: 实现代码描述实际处理
- **依赖关系注入**: 根据需要使用依赖注入模式实现

## 阶段性实现指南

1. **首先只通过一个测试用例**
   - 避免同时处理多个测试导致复杂化
   - 通过逐个确实实现来保证质量

2. **用最简单的方法实现**
   - 复杂算法在后续重构中添加
   - 重视可读性:现阶段最优先考虑易理解性

3. **考虑代码质量标准**
   - 静态分析对应:力求实现不会在lint或typecheck中出错
   - 格式统一:根据项目现有格式实现
   - 遵守命名规则:按照项目命名规则实现

4. **其他测试用例留待后续**
   - 遵循TDD原则,逐步推进
   - 将变更影响降到最低

5. **错误处理也最小化**
   - 仅实现测试要求的部分
   - 计划在重构阶段添加详细错误处理

## 可靠性级别指示

实现代码创建时,请用以下信号注释各实现内容与原始资料的对照情况:

- 🔵 **蓝色信号**: 参考原始资料几乎没有推测的情况
- 🟡 **黄色信号**: 从原始资料进行合理推测的情况
- 🔴 **红色信号**: 原始资料中没有的推测情况

## 质量判定标准

```
✅ 高质量:
- 测试结果: Task工具执行全部成功
- 实现质量: 简洁且运行
- 重构部分: 可以明确识别
- 功能性问题: 无
- 编译错误: 无
- 文件大小: 800行以下或分割计划明确
- 模拟使用: 实现代码中不包含模拟・桩

⚠️ 需改善:
- 部分测试失败(Task工具检测)
- 实现过于复杂
- 重构方针不明
- 功能存在顾虑
- 存在编译错误
- 文件大小超过800行且分割计划不明
- 实现代码中包含模拟・桩
```

## 文件路径记载规则

- **使用以项目根目录为基准的相对路径**
- 不记载完整路径(绝对路径)
- 例:
  - ❌ `/Users/username/projects/myapp/src/utils/helper.ts`
  - ✅ `src/utils/helper.ts`

# info

<implementation_template>
# 实现时的中文注释要求

实现代码中必须包含以下中文注释:

## 函数・方法级别的注释

```javascript
/**
 * 【功能概要】: [用中文说明此函数的功能]
 * 【实现方针】: [说明为什么选择这种实现方法]
 * 【测试对应】: [明确说明是为了通过哪个测试用例的实现]
 * 🔵🟡🔴 可靠性级别: [此实现在多大程度上基于原始资料]
 * @param {type} paramName - [参数说明]
 * @returns {type} - [返回值说明]
 */
function {{function_name}}(paramName) {
  // 【实现内容】: [实现处理的详细说明]
}
```

## 处理块级别的注释

```javascript
function processData(input) {
  // 【输入值验证】: [检查输入值有效性的理由和方法] 🔵🟡🔴
  if (!input) {
    throw new Error('输入值不正确'); // 【错误处理】: [说明为什么需要此错误] 🔵🟡🔴
  }

  // 【数据处理开始】: [明确主处理的开始] 🔵🟡🔴
  // 【处理方针】: [说明此处理如何贡献于通过测试] 🔵🟡🔴
  const result = {
    // 【结果结构】: [说明返回值的结构及其理由]
    validData: [],
    invalidData: [],
    errors: [],
  };

  // 【返回结果】: [说明返回处理结果的理由和内容]
  return result;
}
```

## 变量・常量的注释

```javascript
// 【常量定义】: [此常量必要的理由和使用目的]
const MAX_FILE_SIZE = 1024 * 1024; // 【限制值】: 设置文件大小上限(1MB)

// 【变量初始化】: [说明为了通过测试为什么需要此变量]
let processedCount = 0; // 【计数器】: 用于跟踪已处理文件数的计数器
```

## 错误处理的注释

```javascript
try {
  // 【执行实际处理】: [执行实际处理部分的说明]
  const data = processFile(filePath);
} catch (error) {
  // 【捕获错误】: [发生错误时的处理方针]
  // 【测试要求对应】: [为满足测试期望的错误处理的处理]
  return {
    success: false,
    error: error.message, // 【错误信息】: 适当返回在测试中验证的错误消息
  };
}
```

# 实现示例

```javascript
/**
 * 【功能概要】: 验证JSON文件路径,分类有效/无效路径
 * 【实现方针】: 仅实现通过测试用例所需的最低限度功能
 * 【测试对应】: 为通过在tdd-red阶段创建的测试用例的实现
 */
function {{function_name}}(input) {
  // 【输入值验证】: 早期检测不正确的输入值以防止错误
  if (!input) {
    // 【错误处理】: 对应测试中期望的错误情况
    throw new Error('需要输入值');
  }

  // 【最小实现】: 通过测试的最简单实现
  // 【允许硬编码】: 因计划在重构阶段改善,现阶段固定值也可以
  return {{simple_return_value}};
}
```

# 提供的信息

1. **实现代码**: 通过测试的代码(附带必要的中文注释)
2. **测试执行结果**: 使用Task工具实际确认测试通过
3. **实现说明**: 以什么想法实现的(与中文注释的对应关系)
4. **课题识别**: 当前实现的问题点(明确重构对象)
5. **文件大小检查**: 确认实现文件的行数(超过800行时的分割计划)
6. **模拟使用确认**: 确认实现代码中不包含模拟・桩
</implementation_template>
